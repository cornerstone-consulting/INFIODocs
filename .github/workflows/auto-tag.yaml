name: Auto Tag
on:
  push:
    branches: ["*"]
 
permissions:
  contents: write
 
jobs:
  tag:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
 
      - name: Get latest tag
        id: get_tag
        run: |
          git fetch --tags
          TAG=$(git tag --sort=-v:refname | head -n 1)
          if [ -z "$TAG" ]; then TAG="v0.0.0"; fi
          echo "current_tag=$TAG" >> $GITHUB_OUTPUT
 
      - name: Determine bump type from commit messages
        id: bump_type
        run: |
          commits=$(git log -1 --pretty=%B)
          bump="patch"
          if echo "$commits" | grep -q "BREAKING CHANGE"; then
            bump="major"
          elif echo "$commits" | grep -q "feat:"; then
            bump="minor"
          elif echo "$commits" | grep -q "fix:"; then
            bump="patch"
          fi
          echo "bump=$bump" >> $GITHUB_OUTPUT
 
      - name: Bump version
        id: bump_version
        run: |
          current_tag="${{ steps.get_tag.outputs.current_tag }}"
          bump_type="${{ steps.bump_type.outputs.bump }}"
          version=${current_tag#v}
          IFS='.' read -r major minor patch <<< "$version"
          case "$bump_type" in
            major) major=$((major+1)); minor=0; patch=0;;
            minor) minor=$((minor+1)); patch=0;;
            *)     patch=$((patch+1));;
          esac
          new_tag="v$major.$minor.$patch"
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
 
      - name: Push new tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ steps.bump_version.outputs.new_tag }}"
          git push origin "${{ steps.bump_version.outputs.new_tag }}"